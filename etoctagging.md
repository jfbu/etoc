# technical brief on etoc tagging (WIP)

We will try to keep these items in sync with the actual code, but they may be lagging behind.

- special uses of `etoc` may execute `\(local)tableofcontents` not to typeset, but to build some structures; for such cases in particular `\etoctaggingoff` and `\etoctaggingon` are provided, to control whether `etoc` adds automatically tagging,
- user level interface macros are provided (see the [Change log](/ChangeLog.md)) to insert tagging manually, this is useful for sophisticated TOCs from the previous item, where `\tableofcontents` typesets nothing but only prepares some tokens which are used later, for example in a TikZ picture, see the [toc as a molecule demo](/test_issues/test_tagging_toc_as_molecule.tex) example,
- `etoc` uses the kernel `\@starttoc@cfgpoint@before{toc}` and `\@starttoc@cfgpoint@after{toc}` before and after the `.toc` file contents, (*this has to be kept in sync with upstream evolving interface*),
- for local TOCs (inclusive of local lists of figures or tables) it uses as argument to kernel configuration points `{localtoc}` in place of `{toc}`,
- `etoc` if left in compatibility mode simply executes the contents of the `.toc` file (with its `\contentsline` entries which have been updated by kernel to do tagging) so it has nothing more to do,
- else it uses `\@contentsline@cfgpoint@before{#1}{#2}{#3}{#4}` and `\@contentsline@cfgpoint@after{#1}{#2}{#3}{#4}` in `\Etoc@etoccontentsline@`, (*this has to be kept in sync with upstream evolving interface*),
- actually the `#2` is now replaced by `\etocthename` (which will then be expanded immediately by kernel code);
- from this point on the tagging is done using the [tagpdf](https://github.com/latex3/tagpdf) mark-up API,
- [WIP] (some further thoughts are needed on this overall design) the `<prefix>` and `<contents>` of the line style are inside a `tag=Reference` struct; but at the start of their expansion they are in an mc chunk tagged as `artifact`, using `\tagmcbegin{artifact=layout}`,
- [WIP] `\etocname`, `\etocnumber`, `\etoclink` each stop the `artifact` and produce their own `tag=Reference` chunk.  The `\etocnumber` inserts a sub-struct with `tag=Lbl`, (TODO: decide if really this must be nested, pdf 1.7 reference seems to say `Lbl` can be direct child of `TOCI`, but I imitated `latex-lab`)
- during this construction the hyperlinks get handled and `\etocthelinkedname`, `\etocthelinkednumber` and `\etocthelinkedpage` are defined in addition to `\etocthetaggedname`, `\etocthetaggednumber` and `\etocthetaggedpage` which contain no hyperlinks, (those latter macros may be dropped or renamed and kept non-user level),
- (independent of tagging) the `\etocthelinkedname` et al. use now a `\protected` wrapper of `hyperlink` which facilitates their use in an `\edef` for advanced usage of `etoc`, see the [toc as a molecule demo](/test_issues/test_tagging_toc_as_molecule.tex), 
- depending on the `\Hy@linktoc` numerical value, the robust macros `\etocname` etc..., are then configured to expand to the linked or the non linked (but still tagged) variants,
- one reason for declaring everything as  `artifact` *except* for name, number, page is that some LaTeX mark-up tagging behavior (currently only `\emph` but perhaps others) was determined to be incompatible with being a direct child of `TOCI` (see jfbu/etoc#6); in expectations that other mark-up would prove problematic the only reasonable way seems to be to have everything apart from `name`, `number` and `page` be artifacts.  Indeed these extras do not seem to define structure, but only a priori will add decorations, *testing is needed here*,
- it was found out necessary to disable the `minipage` kernel tagging sockets, not only for the usage of `minipage` in the `\etocframedstyle` (which is a framing around contents, thus this happens external to the toc contents tagging, and the problem was not related to the TOC related kernel tagging hooks but those in `minipage`) but also as `minipage` can be used in the user toc line specifications and was found incompatible with the above described approach (see jfbu/etoc#4, jfbu/etoc#5), or rather with an earlier one, but it was checked to still be incompatible with the current one,

`etoc` is aware of, and maintains virtually a hierarchical tree of the `.toc` file (or relevant portion to local toc), which seems to be like a potential mirror of  some core low-level actions done by [tagpdf](https://github.com/latex3/tagpdf).  But `etoc` user can arbitrarily reassign levels for doing some rather devious tasks using only the `.toc` file.  As a kind of example, see `etoc`'s own `\locallistoffigures` and `\locallistoftables`.  Some thinking and testing will be needed to see how arbitrary level assignments by user may affect the kernel tagging code which expects a fixed hierarchy.  At least, `etoc` does not define `\toclevel@<levelname` macros for reasons pre-existing tagging, see code comments.  This removes surely potential problems.  Untested, but for example a TOC of all subsections ignoring chapters and sections, as is possible with `etoc` should be tagged fine.  And preliminary testing of `etoc`'s `\locallistoffigures` and `\locallistoftables` seems to be positive.

The [etoctagging.tex](/etoctagging.tex) file is a user level companion to the more technical explications which have been given here.
